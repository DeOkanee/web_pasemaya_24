<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MENTAHAN FORM + UPLOAD FILE</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="Pilih Semester/select.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link
      rel="stylesheet"
      href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  </head>
  <body>
    <header>
      <div
        class="logo-left"
        onclick="window.open('https://uhnsugriwa.ac.id/');"
        style="cursor: pointer"
      >
        <img src="../img/LOGO UHN-01.png" alt="Logo Left" />
      </div>
      <div class="title">
        <h1>
          <img
            src="/img/ICON BEM FDA.png"
            alt="BEM FDA"
            class="icon-bem"
          />
          BEM FDA OFFICIAL
          
        </h1>
      </div>
      <div
        class="logo-right"
        onclick="window.open('https://www.instagram.com/orkemas_fda/');"
        style="cursor: pointer"
      >
        <img src="../img/LOGO ORKEMAS.png" alt="Logo Right" />
      </div>
    </header>

    <section id="form-section" class="kotak">
      <div class="text">
        <h2>Pendaftaran Lomba 2</h2>
      </div>

      <form
        id="form"
        class="container m-4 pl-4"
        action="https://script.google.com/macros/s/AKfycbwulTpw2t9dVk_tiSvAoRPHYm80GE5o0lseP_bzoejdlmnQELXeWd1XDyT3qt1-Gao0/exec"
        method="post"
        enctype="multipart/form-data"
        onsubmit="handleSubmit(event)"
      >
        <div class="field">
          <label class="label">NIM</label>
          <div class="control">
            <input
              class="input"
              type="text"
              placeholder="NIM"
              name="NIM"
              id="nim"
            />
          </div>
        </div>

        <div class="field">
          <label class="label">Name</label>
          <div class="control">
            <input
              class="input"
              type="text"
              placeholder="Name Lengkap"
              name="Name"
              id="name"
            />
          </div>
        </div>

        <div class="field">
          <label class="label">Email</label>
          <div class="control">
            <input
              class="input"
              type="email"
              placeholder="Email Aktif"
              name="Email"
              id="email"
            />
          </div>
        </div>

        <div class="field">
          <label class="label">Tanggal Lahir</label>
          <div class="control">
            <input
              class="input"
              type="text"
              placeholder="Tanggal Lahir"
              name="Tanggal"
              id="tanggal"
            />
          </div>
        </div>

        <script>
          $(document).ready(function () {
            $("#tanggal").datepicker({
              dateFormat: "dd/mm/yy",
              changeYear: true,
              yearRange: "2000:c",
              defaultDate: new Date(2000, 0, 1),
            });
          });
        </script>

        <div class="field">
          <label class="label">Gender</label>
          <div class="control">
            <label class="radio">
              <input
                type="radio"
                name="Gender"
                value="Laki-laki"
                id="gender_laki"
              />
              Laki-laki
            </label>
            <label class="radio">
              <input
                type="radio"
                name="Gender"
                value="Perempuan"
                id="gender_perempuan"
              />
              Perempuan
            </label>
          </div>
        </div>

        <div class="field">
          <label class="label">Kelas</label>
          <div class="control">
            <input
              class="input"
              type="text"
              placeholder="Contoh: A2 Denpasar"
              name="Kelas"
              id="kelas"
            />
          </div>
        </div>
        <div class="field">
          <label class="label">Semester</label>
          <div class="control">
            <div class="custom-select">
              <select name="Semester" id="semester">
                <option value="" disabled selected>Pilih Semester</option>
                <!-- Loop untuk semester 1 sampai 20 -->
                <script>
                  for (let i = 1; i <= 20; i++) {
                    document.write(
                      `<option value="${i}">Semester ${i}</option>`
                    );
                  }
                </script>
              </select>
            </div>
          </div>
        </div>

        <div class="field">
          <label class="label">Alamat</label>
          <div class="control">
            <textarea
              rows="4"
              class="textarea"
              placeholder="Alamat Lengkap"
              name="Alamat"
              id="alamat"
            ></textarea>
          </div>
        </div>
        <!-- WHATSAPP-->
        <div class="field">
          <label class="label">Nomor WhatsApp</label>
          <div class="control">
            <span class="prefix"></span>
            <input
              class="input input-prefix"
              type="text"
              placeholder="Nomor WhatsApp Aktif"
              name="WhatsApp"
              id="whatsapp"
            />
          </div>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", () => {
            const whatsappInput = document.getElementById("whatsapp");
            whatsappInput.value = "+62";

            whatsappInput.addEventListener("focus", () => {
              if (whatsappInput.value === "+62") {
                whatsappInput.setSelectionRange(3, 3); // Posisikan kursor setelah +62
              }
            });

            whatsappInput.addEventListener("input", () => {
              if (!whatsappInput.value.startsWith("+62")) {
                whatsappInput.value = "+62";
              }
            });
          });
        </script>
        <!-- WHATSAPP-->
        <div class="field">
          <label class="label">Upload File</label>
          <p class="text-file">Ukuran file tergantung lama mengirim</p>
          <div class="control">
            <input
              class="input"
              type="file"
              name="fileToUpload"
              id="fileToUpload"
            />
          </div>
        </div>

        <div class="field is-grouped">
          <div class="control">
            <button class="button is-primary" type="submit" id="submit-button">
              Kirim
            </button>
          </div>
        </div>
      </form>
    </section>

    <section
      id="success-section"
      class="kotak"
      style="display: none; margin-top: 50px"
    >
      <div id="data-terimpan">
        <h2>Data Anda Berhasil Dikirim!</h2>
        <div class="button-group">
          <a href="/index.html" class="button is-primary download-button"
            >Kembali</a
          >
          <button class="button is-primary" onclick="handleAnother()">
            Kirim data ulang
          </button>
        </div>
      </div>
    </section>

    <script src="Pilih Semester/drop.js"></script>
    <script>
      function handleSubmit(event) {
        event.preventDefault(); // Prevent the default form submission

        const nim = document.getElementById("nim").value;
        const name = document.getElementById("name").value;
        const email = document.getElementById("email").value;
        const tanggal = document.getElementById("tanggal").value;
        const genderLaki = document.getElementById("gender_laki").checked;
        const genderPerempuan =
          document.getElementById("gender_perempuan").checked;
        const kelas = document.getElementById("kelas").value;
        const semester = document.getElementById("semester").value;
        const alamat = document.getElementById("alamat").value;
        const whatsapp = document.getElementById("whatsapp").value;
        const file = document.getElementById("fileToUpload").files[0];

        const submitButton = document.getElementById("submit-button");

        // Check if any required field is empty
        if (
          nim === "" ||
          name === "" ||
          email === "" ||
          tanggal === "" ||
          (!genderLaki && !genderPerempuan) ||
          kelas === "" ||
          semester === "" ||
          alamat === "" ||
          whatsapp === "" ||
          !file
        ) {
          // Jika ada yang kosong, tampilkan "Kirim"
          submitButton.textContent = "Kirim";
          return;
        }

        // Jika semua terisi, tampilkan "Sedang Mengirim..."
        submitButton.textContent = "Sedang Mengirim...tunggu notif success";

        setTimeout(() => {
          submitButton.textContent = "Kirim"; // Mengembalikan teks tombol menjadi "Kirim" setelah 5 detik
        }, 5000);

        // Lakukan pengiriman data
        // (Tambahkan kode pengiriman data di sini, seperti yang Anda lakukan sebelumnya)
      }
    </script>
    <script>
      const form = document.getElementById("form");
      const Toast = Swal.mixin({
        toast: true,
        position: "top-end",
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true,
        didOpen: (toast) => {
          toast.onmouseenter = Swal.stopTimer;
          toast.onmouseleave = Swal.resumeTimer;
        },
      });

      function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
        const expires = "expires=" + d.toUTCString();
        document.cookie = name + "=" + value + ";" + expires + ";path=/";
      }

      function getCookie(name) {
        const cname = name + "=";
        const decodedCookie = decodeURIComponent(document.cookie);
        const ca = decodedCookie.split(";");
        for (let i = 0; i < ca.length; i++) {
          let c = ca[i];
          while (c.charAt(0) == " ") {
            c = c.substring(1);
          }
          if (c.indexOf(cname) == 0) {
            return c.substring(cname.length, c.length);
          }
        }
        return "";
      }

      function checkFormSubmission() {
        const formSubmitted = getCookie("formSubmitted");
        if (formSubmitted) {
          document.getElementById("form-section").style.display = "none";
          document.getElementById("success-section").style.display = "block";
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const file = form.fileToUpload.files[0];

        if (!file) {
          Toast.fire({
            icon: "error",
            title: "Data tidak boleh kosong",
          });
          return;
        }

        const reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = async (event) => {
          const url = form.action;
          const qs = new URLSearchParams({
            filename: file.name,
            mimeType: file.type,
            NIM: form.NIM.value,
            Name: form.Name.value,
            Email: form.Email.value,
            Tanggal: form.Tanggal.value,
            Gender: form.Gender.value,
            Kelas: form.Kelas.value,
            Semester: form.Semester.value,
            Alamat: form.Alamat.value,
            WhatsApp: form.WhatsApp.value,
          });

          const fileArray = [...new Int8Array(event.target.result)];
          const response = await fetch(`${url}?${qs}`, {
            method: "POST",
            body: JSON.stringify(fileArray),
          });

          if (response.ok) {
            const data = await response.json();
            setCookie("formSubmitted", "true", 1);
            Toast.fire({
              icon: "success",
              title: "Data success dikirim",
            }).then(() => {
              document.getElementById("form-section").style.display = "none";
              document.getElementById("success-section").style.display =
                "block";
            });
          } else {
            Toast.fire({
              icon: "error",
              title: "Gagal mengirim data. Coba lagi.",
            });
          }
        };
      });

      function handleAnother() {
        document.getElementById("form-section").style.display = "block";
        document.getElementById("success-section").style.display = "none";
        document.getElementById("form").reset();
        document.cookie =
          "formSubmitted=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      }

      document.addEventListener("DOMContentLoaded", checkFormSubmission);
    </script>
  </body>
</html>